<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²Ù† Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary:#2e7d32; --primary-dark:#1b5e20; --accent:#81c784;
      --bg:#f5f6f4; --card:#fff; --muted:#6b6b6b; --danger:#c62828; --warning:#ef6c00;
      --radius:14px; --info:#1565c0; --purple:#7b1fa2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Tajawal',Arial,sans-serif;background:var(--bg);color:#111}
    a{color:var(--primary)}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;color:#fff;font-weight:700}
    h1{margin:0;font-size:22px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button, .btn{border:none;background:var(--primary);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s}
    button:hover, .btn:hover{opacity:0.9;transform:translateY(-2px)}
    button.secondary{background:#e8f5e9;color:#185a1b}
    button.warning{background:var(--warning)}
    button.danger{background:var(--danger)}
    button.info{background:var(--info)}
    button.purple{background:var(--purple)}
    button:disabled{opacity:.6;cursor:not-allowed}.grid{display:grid;gap:16px}
    .cards{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:992px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:560px){.cards{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
    .metric{display:flex;align-items:center;justify-content:space-between}
    .metric .value{font-weight:700;font-size:22px}
    .metric .label{color:var(--muted)}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:12px 0}
    .toolbar .left, .toolbar .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input, select{height:40px;border:1px solid #e7e7e7;border-radius:12px;padding:0 12px;background:#fff;font-family:inherit}
    input:focus, select:focus{outline:2px solid #cde9ce;border-color:#cde9ce}
    input[type="number"]{direction:ltr;text-align:right}

    .table-wrap{overflow:auto;border:1px solid #eee;border-radius:16px}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th,td{padding:12px;border-bottom:1px solid #f3f3f3;background:#fff;vertical-align:middle}
    th{background:#fafafa;color:#333}
    tbody tr:hover{background:#fafdfb}
    .pill{padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
    .pill.low{background:#ffebee;color:#b71c1c}
    .pill.ok{background:#e8f5e9;color:#1b5e20}

    .badge{background:#e3f2fd;color:#0d47a1;border-radius:999px;padding:2px 10px;font-size:12px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.show{display:flex}
    .modal .box{background:#fff;max-width:720px;width:100%;border-radius:18px;padding:16px;max-height:90vh;overflow-y:auto}
    .box header{margin-bottom:8px}
    .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:560px){.form-grid{grid-template-columns:1fr}}
    .box footer{display:flex;gap:8px;justify-content:flex-start;margin-top:10px}

    .hint{color:var(--muted);font-size:12px}
    .empty{padding:18px;color:var(--muted);text-align:center}

    /* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
    .charts-container {display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;}
    .chart-card {background: #fff; border-radius: var(--radius); padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.05);}
    @media(max-width: 992px) {.charts-container {grid-template-columns: 1fr;}}

    /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
    .alerts-container {margin: 16px 0;}
    .alert {padding: 12px 16px; border-radius: var(--radius); margin-bottom: 8px; display: flex; align-items: center; gap: 12px;}
    .alert.warning {background: #fff8e1; border-right: 4px solid var(--warning);}
    .alert.danger {background: #ffebee; border-right: 4px solid var(--danger);}
    .alert.info {background: #e3f2fd; border-right: 4px solid var(--info);}

    /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .loader {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: #f1f1f1; z-index: 9999;}
    .loader::before {content: ''; position: absolute; height: 3px; width: 50%; background: var(--primary); animation: loading 1.5s ease-in-out infinite;}

    @keyframes loading {
      0% {left: -50%;}
      100% {left: 100%;}
    }

    /* Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© */
    .recent-activity {margin-top: 24px;}
    .activity-item {display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee;}
    .activity-item:last-child {border-bottom: none;}
    .activity-type {display: flex; align-items: center; gap: 8px;}
    .activity-in {color: var(--primary);}
    .activity-out {color: var(--danger);}
    .activity-date {color: var(--muted); font-size: 0.9em;}

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ */
    .connection-settings {background: #e8f5e9; padding: 16px; border-radius: var(--radius); margin-bottom: 20px;}
    .connection-settings h3 {margin-top: 0;}
    .connection-form {display: grid; grid-template-columns: 1fr auto; gap: 10px;}
    @media(max-width: 560px) {.connection-form {grid-template-columns: 1fr;}}

    /* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© */
    .local-data-actions {display: flex; gap: 8px; margin: 16px 0; flex-wrap: wrap;}
    
    /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tabs {display: flex; gap: 8px; margin-bottom: 16px;}
    .tab {padding: 10px 16px; background: #e0e0e0; border-radius: var(--radius); cursor: pointer;}
    .tab.active {background: var(--primary); color: white;}
    
    /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© */
    .status-message {padding: 10px; border-radius: var(--radius); margin: 10px 0; text-align: center;}
    .status-success {background: #e8f5e9; color: #2e7d32;}
    .status-error {background: #ffebee; color: #c62828;}
    .status-warning {background: #fff8e1; color: #ef6c00;}
  </style>
</head>
<body>
  <div class="loader" id="mainLoader"></div>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">âš™ï¸</div>
        <div>
          <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²Ù† Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</h1>
          <div class="hint" id="connectionStatus">âšª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ Google Sheets</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnAdd">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
        <button class="secondary" id="btnIn">â¬†ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²ÙˆÙ†ÙŠ</button>
        <button class="secondary" id="btnOut">â¬‡ï¸ Ø¥Ø®Ø±Ø§Ø¬ Ù…Ø®Ø²ÙˆÙ†ÙŠ</button>
        <button class="warning" id="btnRefresh">â†» ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </header>
    
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="connection-settings card">
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets</h3>
      <div class="connection-form">
        <input type="text" id="scriptUrl" placeholder="Ø±Ø§Ø¨Ø· Web App Ù…Ù† Google Apps Script" />
        <button id="btnConnect">Ø§ØªØµØ§Ù„</button>
      </div>
      <div class="hint">Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Web AppØŒ Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª ÙÙŠ <a href="#" id="helpLink">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</a></div>
    </div>
    
    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© -->
    <div class="local-data-actions">
      <button class="info" id="btnExportLocal">ğŸ’¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
      <button class="info" id="btnImportLocal">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
      <button class="danger" id="btnClearLocal">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
    </div>
    
    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div class="tab" data-tab="inventory">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
      <div class="tab" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    </div>
    
    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    <section class="grid cards">
      <div class="card metric"><div>
        <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
        <div class="value" id="m_items">0</div>
      </div><span class="badge">Ø§Ù„Ù…Ø®Ø²Ù†</span></div>
      <div class="card metric"><div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
        <div class="value" id="m_qty">0</div>
      </div><span class="badge">Ø§Ù„ÙˆØ­Ø¯Ø§Øª</span></div>
      <div class="card metric"><div>
        <div class="label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</div>
        <div class="value" id="m_value">0 Ø¯Ø¬</div>
      </div><span class="badge">Ø¯Ø¬</span></div>
      <div class="card metric"><div>
        <div class="label">Ø£ØµÙ†Ø§Ù ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</div>
        <div class="value" id="m_low">0</div>
      </div><span class="badge">ØªÙ†Ø¨ÙŠÙ‡</span></div>
    </section>
    
    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts-container">
      <div class="chart-card">
        <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©</h3>
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶ -->
    <div class="alerts-container" id="alertsContainer">
      <div class="alert info">
        <i class="fas fa-info-circle"></i>
        <div>ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets</div>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
    <div class="toolbar card">
      <div class="left">
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ù„Ù…ÙˆØ±Ø¯ØŒ Ø£Ùˆ Ø§Ù„ÙØ¦Ø©"/>
        <select id="filterCat"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
        <select id="filterStatus">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="low">ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</option>
          <option value="ok">Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯</option>
        </select>
      </div>
      <div class="right">
        <button class="info" id="btnCharts"><i class="fas fa-chart-bar"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ…</button>
        <button class="purple" id="btnReports"><i class="fas fa-file-alt"></i> ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button class="secondary" id="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
            <th>Ø§Ù„ÙØ¦Ø©</th>
            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
            <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
            <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¯Ø¬)</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="12" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯â€¦</td></tr></tbody>
      </table>
    </div>

    <!-- Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© -->
    <div class="card recent-activity">
      <h3>Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</h3>
      <div id="recentActivities">
        <div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø­Ø¯ÙŠØ«Ø©</div>
      </div>
    </div>

  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù -->
  <div class="modal" id="modalItem">
    <div class="box">
      <header>
        <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h3>
      </header>
      <div class="form-grid">
        <div><label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</label><input id="f_code" placeholder="Ù…Ø«Ø§Ù„: BR-001"></div>
        <div><label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label><input id="f_name" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±ÙŠÙƒ Ø£Ù…Ø§Ù…ÙŠ"></div>
        <div><label>Ø§Ù„ÙØ¦Ø©</label><input id="f_cat" placeholder="ÙØ±Ø§Ù…Ù„/ÙÙ„ØªØ±/Ù…Ø­Ø±Ùƒâ€¦"></div>
        <div><label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><input id="f_loc" placeholder="Ø±Ù A1"></div>
        <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input id="f_supplier" placeholder="Ø´Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†"></div>
        <div><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</label><input type="number" id="f_min" value="0"></div>
        <div><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="f_qty" value="0"></div>
        <div><label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¯Ø¬)</label><input type="number" id="f_price" value="0"></div>
      </div>
      <footer>
        <button id="saveItem">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="secondary" data-close>Ø¥Ù„ØºØ§Ø¡</button>
      </footer>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„/Ø¥Ø®Ø±Ø§Ø¬ -->
  <div class="modal" id="modalMove">
    <div class="box">
      <header>
        <h3 id="moveTitle">Ø­Ø±ÙƒØ© Ù…Ø®Ø²ÙˆÙ†ÙŠØ©</h3>
      </header>
      <div class="form-grid">
        <div><label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</label><input id="mv_code" placeholder="BR-001"></div>
        <div><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="mv_qty" value="1"></div>
        <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="mv_note" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø±ÙƒØ© (ÙØ§ØªÙˆØ±Ø©ØŒ Ù…Ø±ØªØ¬Ø¹â€¦)"></div>
      </div>
      <footer>
        <button id="applyMove">ØªØ·Ø¨ÙŠÙ‚</button>
        <button class="secondary" data-close>Ø¥Ù„ØºØ§Ø¡</button>
      </footer>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
  <div class="modal" id="modalHelp">
    <div class="box">
      <header>
        <h3>Ø¯Ù„ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ Google Apps Script</h3>
      </header>
      <div>
        <p>Ù„Ø±Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Google SheetsØŒ Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
        <ol>
          <li>Ø£Ù†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯ ÙÙŠ Google Sheets</li>
          <li>Ø§ÙØªØ­ Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© (Tools â†’ Script editor)</li>
          <li>Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ù…Ù† <a href="#" id="copyScriptLink">Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·</a> ÙˆØ§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±</li>
          <li>Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ³Ù…Ù‘Ù‡ ÙƒÙ…Ø§ ØªØ±ÙŠØ¯</li>
          <li>Ø§Ù†Ø´Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Deploy â†’ New deployment â†’ Web App)</li>
          <li>Ø¹ÙŠÙ‘Ù† "Who has access" Ø¥Ù„Ù‰ "Anyone"</li>
          <li>Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Web App ÙˆØ§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰</li>
        </ol>
      </div>
      <footer>
        <button class="secondary" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
      </footer>
    </div>
  </div>

  <script>
    /* ======== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Google Apps Script ======== */
    let SCRIPT_URL = localStorage.getItem('inventory_script_url') || "";
    let CONNECTED = false;

    /* ======== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ======== */
    let ITEMS = []; // Ø§Ù„Ø£ØµÙ†Ø§Ù
    let FILTER = { q:"", cat:"", status:"" };
    let categoryChart, statusChart;

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶
    const sampleData = [
      { code: "BRK-001", name: "Ø¨Ø±ÙŠÙƒ Ø£Ù…Ø§Ù…ÙŠ", category: "ÙØ±Ø§Ù…Ù„", location: "Ø±Ù A1", supplier: "Ø´Ø±ÙƒØ© Ø§Ù„ÙØ±Ø§Ù…Ù„", min: 5, qty: 3, price: 2500 },
      { code: "OIL-002", name: "Ø²ÙŠØª Ù…Ø­Ø±Ùƒ", category: "Ø²ÙŠÙˆØª", location: "Ø±Ù B2", supplier: "Ø´Ø±ÙƒØ© Ø§Ù„Ø²ÙŠÙˆØª", min: 10, qty: 15, price: 800 },
      { code: "FLT-003", name: "ÙÙ„ØªØ± Ù‡ÙˆØ§Ø¡", category: "ÙÙ„Ø§ØªØ±", location: "Ø±Ù C3", supplier: "Ø´Ø±ÙƒØ© Ø§Ù„ÙÙ„Ø§ØªØ±", min: 8, qty: 5, price: 1200 },
      { code: "BLT-004", name: "Ø³ÙŠØ± Ù…Ø­Ø±Ùƒ", category: "Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª", location: "Ø±Ù D4", supplier: "Ø´Ø±ÙƒØ© Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª", min: 3, qty: 7, price: 1500 },
      { code: "SPK-005", name: "Ø´Ù…Ø¹Ø© Ø§Ø­ØªØ±Ø§Ù‚", category: "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª", location: "Ø±Ù E5", supplier: "Ø´Ø±ÙƒØ© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª", min: 12, qty: 20, price: 400 }
    ];

    // Ù…Ø³Ø§Ø¹Ø¯ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
    async function api(action, payload = {}) {
      if (!SCRIPT_URL || SCRIPT_URL.includes('https://script.google.com/macros/s/AKfycbyoW8BP73cMHF29DxsV3XNnNYTrZVCDaQpQQswr3bixkaUhHLGCn6TcICek_GODZesE/exec')) {
        // Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
        await simulateApiCall(action, payload);
        return { success: true };
      }

      toggleLoader(true);
      try {
        const body = JSON.stringify({ action, ...payload });
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body,
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        return data;
      } catch (e) {
        console.error("API Error:", e);
        
        // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± (Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        try {
          const body = JSON.stringify({ action, ...payload });
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body,
            headers: {
              "Content-Type": "application/json"
            }
          });
          
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return await res.json();
        } catch (retryError) {
          // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          await simulateApiCall(action, payload);
          return { success: true };
        }
      } finally {
        toggleLoader(false);
      }
    }

    // Ù…Ø­Ø§ÙƒØ§Ø© API Ù„Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
    async function simulateApiCall(action, payload) {
      await new Promise(resolve => setTimeout(resolve, 300)); // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±
      
      switch (action) {
        case 'add':
          if (!payload.item) throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
          if (ITEMS.some(item => item.code === payload.item.code)) {
            throw new Error('Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
          }
          ITEMS.push(payload.item);
          localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
          break;
          
        case 'update':
          if (!payload.item) throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
          const index = ITEMS.findIndex(item => item.code === payload.item.code);
          if (index === -1) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ù');
          ITEMS[index] = payload.item;
          localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
          break;
          
        case 'delete':
          if (!payload.code) throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
          ITEMS = ITEMS.filter(item => item.code !== payload.code);
          localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
          break;
          
        case 'move':
          if (!payload.code || payload.qty === undefined) throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
          const itemIndex = ITEMS.findIndex(item => item.code === payload.code);
          if (itemIndex === -1) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ù');
          
          const newQty = ITEMS[itemIndex].qty + payload.qty;
          if (newQty < 0) throw new Error('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©');
          
          ITEMS[itemIndex].qty = newQty;
          localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
          
          // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©
          const activities = JSON.parse(localStorage.getItem('inventory_activities') || '[]');
          activities.unshift({
            type: payload.qty > 0 ? 'in' : 'out',
            item: payload.code,
            qty: Math.abs(payload.qty),
            note: payload.note || '',
            date: new Date().toLocaleString('ar-DZ')
          });
          localStorage.setItem('inventory_activities', JSON.stringify(activities.slice(0, 50)));
          break;
          
        case 'list':
          // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± ITEMS
          break;
      }
      
      return { success: true };
    }

    // Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Google Apps Script
    async function testConnection() {
      if (!SCRIPT_URL || SCRIPT_URL.includes('https://script.google.com/macros/s/AKfycbyoW8BP73cMHF29DxsV3XNnNYTrZVCDaQpQQswr3bixkaUhHLGCn6TcICek_GODZesE/exec')) {
        return false;
      }
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'list' }),
          headers: { 'Content-Type': 'application/json' }
        });
        
        return response.ok;
      } catch (e) {
        console.error('Connection test failed:', e);
        return false;
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    function updateConnectionStatus(connected) {
      const statusElement = document.getElementById('connectionStatus');
      if (!statusElement) return;
      
      if (connected) {
        statusElement.innerHTML = 'ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù€ Google Sheets';
        statusElement.style.color = 'green';
      } else {
        statusElement.innerHTML = 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ - Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ';
        statusElement.style.color = 'red';
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    function loadLocalData() {
      const savedItems = localStorage.getItem('inventory_items');
      if (savedItems) {
        ITEMS = JSON.parse(savedItems);
      } else {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©
        ITEMS = sampleData;
        localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
      }
      
      const stats = calculateStats(ITEMS);
      const cats = [...new Set(ITEMS.map(item => item.category).filter(Boolean))];
      
      renderStats(stats);
      renderCats(cats);
      renderRows();
      updateCharts();
      renderAlerts();
      renderRecentActivities();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª
    async function loadAll() {
      toggleLoader(true);
      
      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets Ø£ÙˆÙ„Ø§Ù‹
        const isConnected = await testConnection();
        updateConnectionStatus(isConnected);
        
        if (isConnected) {
          const { items, stats, cats } = await api("list");
          ITEMS = items || [];
          
          // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
          localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
          
          renderStats(stats || {});
          renderCats(cats || []);
        } else {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          loadLocalData();
        }
        
        renderRows();
        updateCharts();
        renderAlerts();
        renderRecentActivities();
      } catch (e) {
        console.error("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ", e);
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        loadLocalData();
        updateConnectionStatus(false);
        
        showError("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØªÙ… Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ: " + e.message);
      } finally {
        toggleLoader(false);
      }
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    function calculateStats(items) {
      const totalQty = items.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
      const totalValue = items.reduce((sum, item) => sum + (Number(item.qty) || 0) * (Number(item.price) || 0), 0);
      const lowCount = items.filter(item => (Number(item.qty) || 0) <= (Number(item.min) || 0)).length;
      
      return {
        items: items.length,
        totalQty,
        totalValue,
        lowCount
      };
    }

    function renderCats(cats){
      const sel = document.getElementById('filterCat');
      sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>' + (cats||[]).map(c=>`<option>${c}</option>`).join("");
    }

    function renderStats(s){
      document.getElementById('m_items').textContent = s.items||0;
      document.getElementById('m_qty').textContent = s.totalQty||0;
      document.getElementById('m_value').textContent = (s.totalValue||0).toLocaleString('ar-DZ')+" Ø¯Ø¬";
      document.getElementById('m_low').textContent = s.lowCount||0;
    }

    function matchFilter(it){
      const q = FILTER.q.trim().toLowerCase();
      if(q){
        const blob = [it.code,it.name,it.category,it.location,it.supplier].join(' ').toLowerCase();
        if(!blob.includes(q)) return false;
      }
      if(FILTER.cat && it.category!==FILTER.cat) return false;
      const status = it.qty <= (parseFloat(it.min)||0) ? 'low' : 'ok';
      if(FILTER.status && FILTER.status!==status) return false;
      return true;
    }

    function renderRows(){
      const tbody = document.getElementById('rows');
      if(!ITEMS.length){ tbody.innerHTML = '<tr><td colspan="12" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>'; return; }
      let i=0; const rows = ITEMS.filter(matchFilter).map(it=>{
        const value = (Number(it.qty||0)*Number(it.price||0));
        const low = Number(it.qty||0) <= Number(it.min||0);
        return `<tr>
          <td>${++i}</td>
          <td><span class="badge">${escapeHtml(it.code||'')}</span></td>
          <td>${escapeHtml(it.name||'')}</td>
          <td>${escapeHtml(it.category||'')}</td>
          <td>${escapeHtml(it.location||'')}</td>
          <td>${escapeHtml(it.supplier||'')}</td>
          <td>${it.min||0}</td>
          <td>${it.qty||0}</td>
          <td>${Number(it.price||0).toLocaleString('ar-DZ')}</td>
          <td>${value.toLocaleString('ar-DZ')}</td>
          <td>${low?'<span class="pill low">Ù…Ù†Ø®ÙØ¶</span>':'<span class="pill ok">Ø¬ÙŠØ¯</span>'}</td>
          <td>
            <button class="secondary" onclick='openItem(${JSON.stringify(it)})'>ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="danger" onclick='delItem("${encodeURIComponent(it.code)}")'>Ø­Ø°Ù</button>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows || '<tr><td colspan="12" class="empty">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
    }

    function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØµÙ†Ù (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„)
    function openItem(it){
      document.getElementById('formTitle').textContent = it? 'ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù' : 'Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù';
      document.getElementById('f_code').value = it?.code||'';
      document.getElementById('f_name').value = it?.name||'';
      document.getElementById('f_cat').value = it?.category||'';
      document.getElementById('f_loc').value = it?.location||'';
      document.getElementById('f_supplier').value = it?.supplier||'';
      document.getElementById('f_min').value = it?.min||0;
      document.getElementById('f_qty').value = it?.qty||0;
      document.getElementById('f_price').value = it?.price||0;
      showModal('modalItem', true);
      // Ø¬Ø¹Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      document.getElementById('f_code').disabled = !!it;
    }

    async function saveItem(){
      const payload = {
        code: val('f_code'), name: val('f_name'), category: val('f_cat'), location: val('f_loc'), supplier: val('f_supplier'),
        min: num('f_min'), qty: num('f_qty'), price: num('f_price')
      };
      if(!payload.code || !payload.name) return showError('Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙˆØ§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© Ø­Ù‚ÙˆÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©');
      
      try{
        if (SCRIPT_URL && CONNECTED) {
          const mode = document.getElementById('f_code').disabled ? 'update' : 'add';
          await api(mode, { item: payload });
        } else {
          // Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
          if (document.getElementById('f_code').disabled) {
            // ØªØ¹Ø¯ÙŠÙ„
            const index = ITEMS.findIndex(item => item.code === payload.code);
            if (index !== -1) {
              ITEMS[index] = payload;
            }
          } else {
            // Ø¥Ø¶Ø§ÙØ©
            if (ITEMS.some(item => item.code === payload.code)) {
              return showError('Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
            }
            ITEMS.push(payload);
          }
          localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
        }
        
        await loadAll();
        showModal('modalItem', false);
        showSuccess('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){ showError('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+e.message); }
    }

    async function delItem(code){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ')) return;
      
      try{
        if (SCRIPT_URL && CONNECTED) {
          await api('delete', { code: decodeURIComponent(code) });
        } else {
          // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ
          ITEMS = ITEMS.filter(item => item.code !== decodeURIComponent(code));
          localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
        }
        
        await loadAll();
        showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){ showError('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù: '+e.message); }
    }

    // Ø­Ø±ÙƒØ© Ù…Ø®Ø²ÙˆÙ†ÙŠØ©
    let MOVE_TYPE = 'in';
    function openMove(type){
      MOVE_TYPE = type; // 'in' or 'out'
      document.getElementById('moveTitle').textContent = type==='in' ? 'Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²ÙˆÙ†ÙŠ' : 'Ø¥Ø®Ø±Ø§Ø¬ Ù…Ø®Ø²ÙˆÙ†ÙŠ';
      showModal('modalMove', true);
    }

    async function applyMove(){
      const code = val('mv_code');
      const qty  = num('mv_qty');
      const note = val('mv_note');
      if(!code || !qty) return showError('Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø§Ù†');
      
      try{
        if (SCRIPT_URL && CONNECTED) {
          await api('move', { code, qty:(MOVE_TYPE==='out'?-Math.abs(qty):Math.abs(qty)), note });
        } else {
          // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø±ÙƒØ© Ù…Ø­Ù„ÙŠØ§Ù‹
          const item = ITEMS.find(item => item.code === code);
          if (item) {
            if (MOVE_TYPE === 'in') {
              item.qty = (Number(item.qty) || 0) + Math.abs(qty);
            } else {
              item.qty = Math.max(0, (Number(item.qty) || 0) - Math.abs(qty));
            }
            
            localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
            const activities = JSON.parse(localStorage.getItem('inventory_activities') || '[]');
            activities.unshift({
              type: MOVE_TYPE,
              item: code,
              qty: Math.abs(qty),
              note: note,
              date: new Date().toLocaleString('ar-DZ')
            });
            localStorage.setItem('inventory_activities', JSON.stringify(activities.slice(0, 10))); // Ø­ÙØ¸ Ø¢Ø®Ø± 10 Ø­Ø±ÙƒØ§Øª ÙÙ‚Ø·
          } else {
            return showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ù');
          }
        }
        
        await loadAll();
        showModal('modalMove', false);
        showSuccess('ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){ showError('ØªØ¹Ø°Ù‘Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø±ÙƒØ©: '+e.message); }
    }

    // ØªØµØ¯ÙŠØ± CSV
    function exportCSV(){
      const cols = ['code','name','category','location','supplier','min','qty','price'];
      const rows = [cols.join(',')].concat(ITEMS.map(it=>cols.map(c=>`"${String(it[c]??'').replaceAll('"','""')}"`).join(',')));
      const blob = new Blob(["\ufeff"+rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'inventory.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    function updateCharts() {
      // Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
      const categories = {};
      ITEMS.forEach(item => {
        const cat = item.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
        categories[cat] = (categories[cat] || 0) + (Number(item.qty) || 0);
      });
      
      if (categoryChart) categoryChart.destroy();
      const catCtx = document.getElementById('categoryChart').getContext('2d');
      categoryChart = new Chart(catCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(categories),
          datasets: [{
            data: Object.values(categories),
            backgroundColor: ['#2e7d32', '#1565c0', '#d32f2f', '#ffa000', '#7b1fa2', '#00897b', '#f57c00', '#5d4037']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'left',
              rtl: true
            }
          }
        }
      });
      
      // Ø±Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©
      let lowCount = 0, okCount = 0;
      ITEMS.forEach(item => {
        if (Number(item.qty) <= Number(item.min)) lowCount++;
        else okCount++;
      });
      
      if (statusChart) statusChart.destroy();
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰', 'Ø¶Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¢Ù…Ù†'],
          datasets: [{
            data: [lowCount, okCount],
            backgroundColor: ['#ef6c00', '#2e7d32']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'left',
              rtl: true
            }
          }
        }
      });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function renderAlerts() {
      const container = document.getElementById('alertsContainer');
      const lowItems = ITEMS.filter(item => Number(item.qty) <= Number(item.min));
      
      if (lowItems.length === 0) {
        container.innerHTML = '<div class="alert info"><i class="fas fa-info-circle"></i> <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¶Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¢Ù…Ù†</div></div>';
        return;
      }
      
      container.innerHTML = `
        <div class="alert warning">
          <i class="fas fa-exclamation-triangle"></i>
          <div>Ù‡Ù†Ø§Ùƒ ${lowItems.length} Ø£ØµÙ†Ø§Ù ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
        </div>
      `;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
    function renderRecentActivities() {
      const container = document.getElementById('recentActivities');
      let activities = [];
      
      if (!CONNECTED) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        activities = JSON.parse(localStorage.getItem('inventory_activities') || []);
      }
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
      
      if (activities.length === 0) {
        container.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø­Ø¯ÙŠØ«Ø©</div>';
        return;
      }
      
      container.innerHTML = activities.map(act => `
        <div class="activity-item">
          <div class="activity-type">
            <i class="fas ${act.type === 'in' ? 'fa-arrow-down activity-in' : 'fa-arrow-up activity-out'}"></i>
            <span>${act.type === 'in' ? 'Ø¥Ø¯Ø®Ø§Ù„' : 'Ø¥Ø®Ø±Ø§Ø¬'} ${act.qty} ÙˆØ­Ø¯Ø© Ù…Ù† ${act.item}</span>
          </div>
          <div>
            <span>${act.note}</span>
            <span class="activity-date">${act.date}</span>
          </div>
        </div>
      `).join('');
    }

    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets
    async function connectToGoogleSheets() {
      const url = document.getElementById('scriptUrl').value.trim();
      if (!url) {
        return showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Web App');
      }
      
      // Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ localStorage
      localStorage.setItem('inventory_script_url', url);
      SCRIPT_URL = url;
      
      toggleLoader(true);
      try {
        const isConnected = await testConnection();
        if (isConnected) {
          CONNECTED = true;
          updateConnectionStatus(true);
          showSuccess('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ù€ Google Sheets');
          await loadAll();
        } else {
          throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets');
        }
      } catch (e) {
        showError('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message);
        updateConnectionStatus(false);
      } finally {
        toggleLoader(false);
      }
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    function exportLocalData() {
      const data = {
        items: ITEMS,
        activities: JSON.parse(localStorage.getItem('inventory_activities') || []
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'inventory_backup.json';
      a.click();
      URL.revokeObjectURL(a.href);
      
      showSuccess('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    function importLocalData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            
            if (data.items) {
              ITEMS = data.items;
              localStorage.setItem('inventory_items', JSON.stringify(ITEMS));
            }
            
            if (data.activities) {
              localStorage.setItem('inventory_activities', JSON.stringify(data.activities));
            }
            
            loadAll();
            showSuccess('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          } catch (e) {
            showError('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message);
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    function clearLocalData() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
      
      localStorage.removeItem('inventory_items');
      localStorage.removeItem('inventory_activities');
      ITEMS = [];
      
      loadAll();
      showSuccess('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
    }

    // Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø©
    function val(id){return document.getElementById(id).value.trim();}
    function num(id){return Number(document.getElementById(id).value||0)}
    function showModal(id,show){ document.getElementById(id).classList.toggle('show', !!show); }
    function toggleLoader(show){ document.getElementById('mainLoader').style.display = show ? 'block' : 'none'; }
    function showError(msg){ alert('Ø®Ø·Ø£: ' + msg); }
    function showSuccess(msg){ alert('Ù†Ø¬Ø§Ø­: ' + msg); }

    // Ø£Ø­Ø¯Ø§Ø«
    document.getElementById('btnAdd').onclick = ()=>openItem();
    document.getElementById('btnIn').onclick  = ()=>openMove('in');
    document.getElementById('btnOut').onclick = ()=>openMove('out');
    document.getElementById('btnRefresh').onclick = loadAll;
    document.getElementById('btnExport').onclick = exportCSV;
    document.getElementById('btnConnect').onclick = connectToGoogleSheets;
    document.getElementById('helpLink').onclick = (e)=>{ e.preventDefault(); showModal('modalHelp', true); };
    document.getElementById('copyScriptLink').onclick = (e)=>{ e.preventDefault(); alert('Ø³ÙŠØªÙ… ØªÙˆÙÙŠØ± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯'); };
    document.getElementById('btnExportLocal').onclick = exportLocalData;
    document.getElementById('btnImportLocal').onclick = importLocalData;
    document.getElementById('btnClearLocal').onclick = clearLocalData;
    
    document.querySelectorAll('[data-close]').forEach(el=>el.onclick=()=>{
      el.closest('.modal').classList.remove('show');
    });
    
    document.getElementById('saveItem').onclick = saveItem;
    document.getElementById('applyMove').onclick = applyMove;

    document.getElementById('search').oninput = e=>{ FILTER.q = e.target.value; renderRows(); };
    document.getElementById('filterCat').onchange = e=>{ FILTER.cat = e.target.value; renderRows(); };
    document.getElementById('filterStatus').onchange = e=>{ FILTER.status = e.target.value; renderRows(); };

    // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„ÙƒÙ„ ØªØ¨ÙˆÙŠØ¨
      });
    });

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    document.getElementById('scriptUrl').value = SCRIPT_URL;
    if (SCRIPT_URL) {
      document.getElementById('connectionStatus').textContent = 'ğŸŸ¡ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets';
      document.getElementById('connectionStatus').style.color = 'orange';
    }
    
    loadAll();
  </script>
</body>
</html>
