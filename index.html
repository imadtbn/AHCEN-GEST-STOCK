<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²Ù† Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --primary:#2e7d32; --primary-dark:#1b5e20; --accent:#81c784;
      --bg:#f5f6f4; --card:#fff; --muted:#6b6b6b; --danger:#c62828; --warning:#ef6c00;
      --radius:14px;
      --info:#1565c0; --purple:#7b1fa2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Tajawal',Arial,sans-serif;background:var(--bg);color:#111}
    a{color:var(--primary)}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;color:#fff;font-weight:700}
    h1{margin:0;font-size:22px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button, .btn{border:none;background:var(--primary);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s}
    button:hover, .btn:hover{opacity:0.9;transform:translateY(-2px)}
    button.secondary{background:#e8f5e9;color:#185a1b}
    button.warning{background:var(--warning)}
    button.danger{background:var(--danger)}
    button.info{background:var(--info)}
    button.purple{background:var(--purple)}
    button:disabled{opacity:.6;cursor:not-allowed}.grid{display:grid;gap:16px}
.cards{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:992px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(max-width:560px){.cards{grid-template-columns:1fr}}

.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
.metric{display:flex;align-items:center;justify-content:space-between}
.metric .value{font-weight:700;font-size:22px}
.metric .label{color:var(--muted)}

.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:12px 0}
.toolbar .left, .toolbar .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input, select{height:40px;border:1px solid #e7e7e7;border-radius:12px;padding:0 12px;background:#fff;font-family:inherit}
input:focus, select:focus{outline:2px solid #cde9ce;border-color:#cde9ce}
input[type="number"]{direction:ltr;text-align:right}

.table-wrap{overflow:auto;border:1px solid #eee;border-radius:16px}
table{width:100%;border-collapse:collapse;min-width:980px}
th,td{padding:12px;border-bottom:1px solid #f3f3f3;background:#fff;vertical-align:middle}
th{background:#fafafa;color:#333}
tbody tr:hover{background:#fafdfb}
.pill{padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
.pill.low{background:#ffebee;color:#b71c1c}
.pill.ok{background:#e8f5e9;color:#1b5e20}

.badge{background:#e3f2fd;color:#0d47a1;border-radius:999px;padding:2px 10px;font-size:12px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal.show{display:flex}
.modal .box{background:#fff;max-width:720px;width:100%;border-radius:18px;padding:16px;max-height:90vh;overflow-y:auto}
.box header{margin-bottom:8px}
.form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(max-width:560px){.form-grid{grid-template-columns:1fr}}
.box footer{display:flex;gap:8px;justify-content:flex-start;margin-top:10px}

.hint{color:var(--muted);font-size:12px}
.empty{padding:18px;color:var(--muted);text-align:center}

/* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
.charts-container {display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;}
.chart-card {background: #fff; border-radius: var(--radius); padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.05);}
@media(max-width: 992px) {.charts-container {grid-template-columns: 1fr;}}

/* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
.alerts-container {margin: 16px 0;}
.alert {padding: 12px 16px; border-radius: var(--radius); margin-bottom: 8px; display: flex; align-items: center; gap: 12px;}
.alert.warning {background: #fff8e1; border-right: 4px solid var(--warning);}
.alert.danger {background: #ffebee; border-right: 4px solid var(--danger);}
.alert.info {background: #e3f2fd; border-right: 4px solid var(--info);}
.alert.offline {background: #f5f5f5; border-right: 4px solid var(--muted);}

/* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.loader {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: #f1f1f1; z-index: 9999;}
.loader::before {content: ''; position: absolute; height: 3px; width: 50%; background: var(--primary); animation: loading 1.5s ease-in-out infinite;}

@keyframes loading {
  0% {left: -50%;}
  100% {left: 100%;}
}

/* Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© */
.recent-activity {margin-top: 24px;}
.activity-item {display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee;}
.activity-item:last-child {border-bottom: none;}
.activity-type {display: flex; align-items: center; gap: 8px;}
.activity-in {color: var(--primary);}
.activity-out {color: var(--danger);}
.activity-date {color: var(--muted); font-size: 0.9em;}

/* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
.notification {position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: var(--radius); color: white; z-index: 1000; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateX(100%); opacity: 0; transition: all 0.3s ease;}
.notification.show {transform: translateX(0); opacity: 1;}
.notification.success {background: var(--primary);}
.notification.error {background: var(--danger);}
.notification.warning {background: var(--warning);}
.notification.info {background: var(--info);}

  </style>
</head>
<body>
  <div class="loader" id="mainLoader"></div>
  
  <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <div class="notification" id="notification">
    <i class="fas fa-info-circle"></i>
    <span id="notificationText"></span>
  </div>
  
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">âš™ï¸</div>
        <div>
          <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²Ù† Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</h1>
          <div class="hint" id="connectionStatus">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ - Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnAdd">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
        <button class="secondary" id="btnIn">â¬†ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²ÙˆÙ†ÙŠ</button>
        <button class="secondary" id="btnOut">â¬‡ï¸ Ø¥Ø®Ø±Ø§Ø¬ Ù…Ø®Ø²ÙˆÙ†ÙŠ</button>
        <button class="warning" id="btnRefresh">â†» ØªØ­Ø¯ÙŠØ«</button>
        <button class="info" id="btnSettings"><i class="fas fa-cog"></i></button>
      </div>
    </header>
    
    <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="alerts-container">
      <div class="alert offline">
        <i class="fas fa-wifi"></i>
        <div>âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø´Ø±.</div>
        <button class="secondary" style="margin-right: auto;" onclick="testConnection()">ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„</button>
      </div>
    </div>
    
    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    <section class="grid cards">
      <div class="card metric"><div>
        <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
        <div class="value" id="m_items">0</div>
      </div><span class="badge">Ø§Ù„Ù…Ø®Ø²Ù†</span></div>
      <div class="card metric"><div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
        <div class="value" id="m_qty">0</div>
      </div><span class="badge">Ø§Ù„ÙˆØ­Ø¯Ø§Øª</span></div>
      <div class="card metric"><div>
        <div class="label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</div>
        <div class="value" id="m_value">0 Ø¯Ø¬</div>
      </div><span class="badge">Ø¯Ø¬</span></div>
      <div class="card metric"><div>
        <div class="label">Ø£ØµÙ†Ø§Ù ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</div>
        <div class="value" id="m_low">0</div>
      </div><span class="badge">ØªÙ†Ø¨ÙŠÙ‡</span></div>
    </section>
    
    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts-container">
      <div class="chart-card">
        <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©</h3>
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶ -->
    <div class="alerts-container" id="alertsContainer">
      <div class="alert info">
        <i class="fas fa-info-circle"></i>
        <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
    <div class="toolbar card">
      <div class="left">
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ù„Ù…ÙˆØ±Ø¯ØŒ Ø£Ùˆ Ø§Ù„ÙØ¦Ø©"/>
        <select id="filterCat"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
        <select id="filterStatus">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="low">ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</option>
          <option value="ok">Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯</option>
        </select>
      </div>
      <div class="right">
        <button class="info" id="btnCharts"><i class="fas fa-chart-bar"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ…</button>
        <button class="purple" id="btnReports"><i class="fas fa-file-alt"></i> ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button class="secondary" id="btnExport"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
            <th>Ø§Ù„ÙØ¦Ø©</th>
            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
            <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
            <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¯Ø¬)</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="12" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯â€¦</td></tr></tbody>
      </table>
    </div>

    <!-- Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© -->
    <div class="card recent-activity">
      <h3>Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</h3>
      <div id="recentActivities">
        <div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø­Ø¯ÙŠØ«Ø©</div>
      </div>
    </div>

  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù -->
  <div class="modal" id="modalItem">
    <div class="box">
      <header>
        <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h3>
      </header>
      <div class="form-grid">
        <div><label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</label><input id="f_code" placeholder="Ù…Ø«Ø§Ù„: BR-001"></div>
        <div><label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label><input id="f_name" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±ÙŠÙƒ Ø£Ù…Ø§Ù…ÙŠ"></div>
        <div><label>Ø§Ù„ÙØ¦Ø©</label><input id="f_cat" placeholder="ÙØ±Ø§Ù…Ù„/ÙÙ„ØªØ±/Ù…Ø­Ø±Ùƒâ€¦"></div>
        <div><label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><input id="f_loc" placeholder="Ø±Ù A1"></div>
        <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input id="f_supplier" placeholder="Ø´Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†"></div>
        <div><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</label><input type="number" id="f_min" value="0"></div>
        <div><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="f_qty" value="0"></div>
        <div><label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¯Ø¬)</label><input type="number" id="f_price" value="0"></div>
      </div>
      <footer>
        <button id="saveItem">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="secondary" data-close>Ø¥Ù„ØºØ§Ø¡</button>
      </footer>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„/Ø¥Ø®Ø±Ø§Ø¬ -->
  <div class="modal" id="modalMove">
    <div class="box">
      <header>
        <h3 id="moveTitle">Ø­Ø±ÙƒØ© Ù…Ø®Ø²ÙˆÙ†ÙŠØ©</h3>
      </header>
      <div class="form-grid">
        <div><label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</label><input id="mv_code" placeholder="BR-001"></div>
        <div><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="mv_qty" value="1"></div>
        <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="mv_note" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø±ÙƒØ© (ÙØ§ØªÙˆØ±Ø©ØŒ Ù…Ø±ØªØ¬Ø¹â€¦)"></div>
      </div>
      <footer>
        <button id="applyMove">ØªØ·Ø¨ÙŠÙ‚</button>
        <button class="secondary" data-close>Ø¥Ù„ØºØ§Ø¡</button>
      </footer>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="modal" id="modalSettings">
    <div class="box">
      <header>
        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
      </header>
      <div style="margin-bottom: 16px;">
        <label>Ø±Ø§Ø¨Ø· Web App</label>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbxXEwdY-yP3T4O7oFVqvd4T7N1_wkdRVcxps6y7Au7mPNP-ccKQTv6zZ3kIDrK_tiExvw/exec" style="width: 100%; margin-top: 8px;">
        <div class="hint">https://script.google.com/macros/s/AKfycbwTj6h0mmiL8LV3T0O9VfgVGYUtoiLe87WhVlDKMT9-wDfLm0DSyBMo50xjzh-FM4kO/exec</div>
      </div>
      <footer>
        <button onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="secondary" data-close>Ø¥Ù„ØºØ§Ø¡</button>
      </footer>
    </div>
  </div>

  <script>
    /* ======== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Google Apps Script ======== */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ID
    const spreadsheetId = "1Tq6pMHdTfZU1ENhXNVQgqxZHafave5FTLP71JvECoI8";
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    const sheet = spreadsheet.getSheetByName("Ø§Ù„Ù…Ø®Ø²Ù†") || spreadsheet.getSheets()[0];
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø¤ÙˆØ³ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(["ÙƒÙˆØ¯", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„ÙØ¦Ø©", "Ø§Ù„Ù…ÙˆÙ‚Ø¹", "Ø§Ù„Ù…ÙˆØ±Ø¯", "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰", "Ø§Ù„ÙƒÙ…ÙŠØ©", "Ø§Ù„Ø³Ø¹Ø±", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«"]);
    }
    
    if (action === "add" || action === "update") {
      const item = data.item;
      const rows = sheet.getDataRange().getValues();
      let found = false;
      
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] === item.code) {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
          sheet.getRange(i+1, 2, 1, 8).setValues([[item.name, item.category, item.location, item.supplier, item.min, item.qty, item.price, new Date()]]);
          found = true;
          break;
        }
      }
      
      if (!found && action === "add") {
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯
        sheet.appendRow([item.code, item.name, item.category, item.location, item.supplier, item.min, item.qty, item.price, new Date(), new Date()]);
      }
      
      return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "list") {
      const rows = sheet.getDataRange().getValues();
      const items = [];
      const categories = new Set();
      
      // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0]) {
          items.push({
            code: rows[i][0],
            name: rows[i][1],
            category: rows[i][2],
            location: rows[i][3],
            supplier: rows[i][4],
            min: rows[i][5],
            qty: rows[i][6],
            price: rows[i][7]
          });
          
          if (rows[i][2]) categories.add(rows[i][2]);
        }
      }
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      let totalQty = 0;
      let totalValue = 0;
      let lowCount = 0;
      
      items.forEach(item => {
        totalQty += Number(item.qty) || 0;
        totalValue += (Number(item.qty) || 0) * (Number(item.price) || 0);
        if ((Number(item.qty) || 0) <= (Number(item.min) || 0)) lowCount++;
      });
      
      return ContentService.createTextOutput(JSON.stringify({
        items: items,
        stats: {
          items: items.length,
          totalQty: totalQty,
          totalValue: totalValue,
          lowCount: lowCount
        },
        cats: Array.from(categories)
      })).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "delete") {
      const code = data.code;
      const rows = sheet.getDataRange().getValues();
      
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] === code) {
          sheet.deleteRow(i+1);
          break;
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "move") {
      const code = data.code;
      const qty = data.qty;
      const rows = sheet.getDataRange().getValues();
      
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] === code) {
          const currentQty = Number(rows[i][6]) || 0;
          sheet.getRange(i+1, 7).setValue(Math.max(0, currentQty + qty));
          sheet.getRange(i+1, 10).setValue(new Date()); // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          break;
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "test") {
      return ContentService.createTextOutput(JSON.stringify({success: true, message: "Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­"})).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({error: "Action not found"})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({error: error.message})).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet() {
  return ContentService.createTextOutput(JSON.stringify({error: "Use POST requests only"})).setMimeType(ContentService.MimeType.JSON);
}    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    init();
  </script>
</body>
</html>
