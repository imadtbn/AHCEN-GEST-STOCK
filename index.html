<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام إدارة مخزن قطع الغيار</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --primary:#2e7d32; --primary-dark:#1b5e20; --accent:#81c784;
      --bg:#f5f6f4; --card:#fff; --muted:#6b6b6b; --danger:#c62828; --warning:#ef6c00;
      --radius:14px;
      --info:#1565c0; --purple:#7b1fa2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Tajawal',Arial,sans-serif;background:var(--bg);color:#111}
    a{color:var(--primary)}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;color:#fff;font-weight:700}
    h1{margin:0;font-size:22px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button, .btn{border:none;background:var(--primary);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s}
    button:hover, .btn:hover{opacity:0.9;transform:translateY(-2px)}
    button.secondary{background:#e8f5e9;color:#185a1b}
    button.warning{background:var(--warning)}
    button.danger{background:var(--danger)}
    button.info{background:var(--info)}
    button.purple{background:var(--purple)}
    button:disabled{opacity:.6;cursor:not-allowed}.grid{display:grid;gap:16px}
.cards{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:992px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(max-width:560px){.cards{grid-template-columns:1fr}}

.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
.metric{display:flex;align-items:center;justify-content:space-between}
.metric .value{font-weight:700;font-size:22px}
.metric .label{color:var(--muted)}

.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:12px 0}
.toolbar .left, .toolbar .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input, select{height:40px;border:1px solid #e7e7e7;border-radius:12px;padding:0 12px;background:#fff;font-family:inherit}
input:focus, select:focus{outline:2px solid #cde9ce;border-color:#cde9ce}
input[type="number"]{direction:ltr;text-align:right}

.table-wrap{overflow:auto;border:1px solid #eee;border-radius:16px}
table{width:100%;border-collapse:collapse;min-width:980px}
th,td{padding:12px;border-bottom:1px solid #f3f3f3;background:#fff;vertical-align:middle}
th{background:#fafafa;color:#333}
tbody tr:hover{background:#fafdfb}
.pill{padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
.pill.low{background:#ffebee;color:#b71c1c}
.pill.ok{background:#e8f5e9;color:#1b5e20}

.badge{background:#e3f2fd;color:#0d47a1;border-radius:999px;padding:2px 10px;font-size:12px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal.show{display:flex}
.modal .box{background:#fff;max-width:720px;width:100%;border-radius:18px;padding:16px;max-height:90vh;overflow-y:auto}
.box header{margin-bottom:8px}
.form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(max-width:560px){.form-grid{grid-template-columns:1fr}}
.box footer{display:flex;gap:8px;justify-content:flex-start;margin-top:10px}

.hint{color:var(--muted);font-size:12px}
.empty{padding:18px;color:var(--muted);text-align:center}

/* الرسوم البيانية */
.charts-container {display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;}
.chart-card {background: #fff; border-radius: var(--radius); padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.05);}
@media(max-width: 992px) {.charts-container {grid-template-columns: 1fr;}}

/* التنبيهات */
.alerts-container {margin: 16px 0;}
.alert {padding: 12px 16px; border-radius: var(--radius); margin-bottom: 8px; display: flex; align-items: center; gap: 12px;}
.alert.warning {background: #fff8e1; border-right: 4px solid var(--warning);}
.alert.danger {background: #ffebee; border-right: 4px solid var(--danger);}
.alert.info {background: #e3f2fd; border-right: 4px solid var(--info);}
.alert.offline {background: #f5f5f5; border-right: 4px solid var(--muted);}

/* مؤشر التحميل */
.loader {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: #f1f1f1; z-index: 9999;}
.loader::before {content: ''; position: absolute; height: 3px; width: 50%; background: var(--primary); animation: loading 1.5s ease-in-out infinite;}

@keyframes loading {
  0% {left: -50%;}
  100% {left: 100%;}
}

/* الحركات الحديثة */
.recent-activity {margin-top: 24px;}
.activity-item {display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee;}
.activity-item:last-child {border-bottom: none;}
.activity-type {display: flex; align-items: center; gap: 8px;}
.activity-in {color: var(--primary);}
.activity-out {color: var(--danger);}
.activity-date {color: var(--muted); font-size: 0.9em;}

/* إشعارات */
.notification {position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: var(--radius); color: white; z-index: 1000; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateX(100%); opacity: 0; transition: all 0.3s ease;}
.notification.show {transform: translateX(0); opacity: 1;}
.notification.success {background: var(--primary);}
.notification.error {background: var(--danger);}
.notification.warning {background: var(--warning);}
.notification.info {background: var(--info);}

.setup-guide { margin: 20px 0; padding: 20px; background: #e8f5e9; border-radius: var(--radius); }
.setup-steps { margin-left: 20px; }
.setup-steps li { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="loader" id="mainLoader"></div>
  
  <!-- إشعارات -->
  <div class="notification" id="notification">
    <i class="fas fa-info-circle"></i>
    <span id="notificationText"></span>
  </div>
  
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">⚙️</div>
        <div>
          <h1>نظام إدارة مخزن قطع الغيار</h1>
          <div class="hint" id="connectionStatus">🔴 غير متصل - يرجى إعداد الاتصال</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnAdd">➕ إضافة صنف</button>
        <button class="secondary" id="btnIn">⬆️ إدخال مخزوني</button>
        <button class="secondary" id="btnOut">⬇️ إخراج مخزوني</button>
        <button class="warning" id="btnRefresh">↻ تحديث</button>
        <button class="info" id="btnSettings"><i class="fas fa-cog"></i></button>
      </div>
    </header>
    
    <!-- دليل الإعداد -->
    <div class="card setup-guide" id="setupGuide">
      <h3>دليل إعداد النظام</h3>
      <ol class="setup-steps">
        <li>أنشئ Google Sheet جديد من <a href="https://sheets.google.com" target="_blank">sheets.google.com</a></li>
        <li>افتح قائمة Tools → Script editor</li>
        <li>انسخ كود Google Apps Script من قسم الإعدادات في التطبيق</li>
        <li>احفظ المشروع ثم انشرها كـ Web App</li>
        <li>انسخ رابط النشر وأدخله في حقل الإعدادات</li>
        <li>انقر على "فحص الاتصال"</li>
      </ol>
      <button onclick="showModal('modalSettings', true)">فتح إعدادات الاتصال</button>
    </div>
    
    <!-- البطاقات -->
    <section class="grid cards">
      <div class="card metric"><div>
        <div class="label">عدد الأصناف</div>
        <div class="value" id="m_items">0</div>
      </div><span class="badge">المخزن</span></div>
      <div class="card metric"><div>
        <div class="label">إجمالي الكمية</div>
        <div class="value" id="m_qty">0</div>
      </div><span class="badge">الوحدات</span></div>
      <div class="card metric"><div>
        <div class="label">قيمة المخزون التقديرية</div>
        <div class="value" id="m_value">0 دج</div>
      </div><span class="badge">دج</span></div>
      <div class="card metric"><div>
        <div class="label">أصناف تحت الحد الأدنى</div>
        <div class="value" id="m_low">0</div>
      </div><span class="badge">تنبيه</span></div>
    </section>
    
    <!-- الرسوم البيانية -->
    <div class="charts-container">
      <div class="chart-card">
        <h3>توزيع المخزون حسب الفئة</h3>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>الحالة المخزنية</h3>
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <!-- تنبيهات المخزون المنخفض -->
    <div class="alerts-container" id="alertsContainer">
      <div class="alert info">
        <i class="fas fa-info-circle"></i>
        <div>جاري تحميل البيانات...</div>
      </div>
    </div>

    <!-- شريط الأدوات -->
    <div class="toolbar card">
      <div class="left">
        <input id="search" placeholder="🔎 بحث بالاسم، الرقم، المورد، أو الفئة"/>
        <select id="filterCat"><option value="">كل الفئات</option></select>
        <select id="filterStatus">
          <option value="">الكل</option>
          <option value="low">تحت الحد الأدنى</option>
          <option value="ok">ضمن الحد</option>
        </select>
      </div>
      <div class="right">
        <button class="info" id="btnCharts"><i class="fas fa-chart-bar"></i> عرض الرسوم</button>
        <button class="purple" id="btnReports"><i class="fas fa-file-alt"></i> تقارير</button>
        <button class="secondary" id="btnExport"><i class="fas fa-file-excel"></i> تصدير Excel</button>
      </div>
    </div>

    <!-- الجدول -->
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>رقم الصنف</th>
            <th>اسم القطعة</th>
            <th>الفئة</th>
            <th>الموقع</th>
            <th>المورد</th>
            <th>الحد الأدنى</th>
            <th>الكمية</th>
            <th>سعر الوحدة (دج)</th>
            <th>القيمة</th>
            <th>الحالة</th>
            <th>خيارات</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="12" class="empty">لا توجد بيانات بعد…</td></tr></tbody>
      </table>
    </div>

    <!-- الحركات الحديثة -->
    <div class="card recent-activity">
      <h3>الحركات الحديثة</h3>
      <div id="recentActivities">
        <div class="empty">لا توجد حركات حديثة</div>
      </div>
    </div>

  </div>

  <!-- نافذة إضافة/تعديل صنف -->
  <div class="modal" id="modalItem">
    <div class="box">
      <header>
        <h3 id="formTitle">إضافة صنف</h3>
      </header>
      <div class="form-grid">
        <div><label>رقم الصنف</label><input id="f_code" placeholder="مثال: BR-001"></div>
        <div><label>اسم القطعة</label><input id="f_name" placeholder="مثال: بريك أمامي"></div>
        <div><label>الفئة</label><input id="f_cat" placeholder="فرامل/فلتر/محرك…"></div>
        <div><label>الموقع</label><input id="f_loc" placeholder="رف A1"></div>
        <div><label>المورد</label><input id="f_supplier" placeholder="شركة الموردين"></div>
        <div><label>الحد الأدنى</label><input type="number" id="f_min" value="0"></div>
        <div><label>الكمية</label><input type="number" id="f_qty" value="0"></div>
        <div><label>سعر الوحدة (دج)</label><input type="number" id="f_price" value="0"></div>
      </div>
      <footer>
        <button id="saveItem">💾 حفظ</button>
        <button class="secondary" data-close>إلغاء</button>
      </footer>
    </div>
  </div>

  <!-- نافذة إدخال/إخراج -->
  <div class="modal" id="modalMove">
    <div class="box">
      <header>
        <h3 id="moveTitle">حركة مخزونية</h3>
      </header>
      <div class="form-grid">
        <div><label>رقم الصنف</label><input id="mv_code" placeholder="BR-001"></div>
        <div><label>الكمية</label><input type="number" id="mv_qty" value="1"></div>
        <div style="grid-column:1/-1"><label>ملاحظة</label><input id="mv_note" placeholder="سبب الحركة (فاتورة، مرتجع…)"></div>
      </div>
      <footer>
        <button id="applyMove">تطبيق</button>
        <button class="secondary" data-close>إلغاء</button>
      </footer>
    </div>
  </div>

  <!-- نافذة الإعدادات -->
  <div class="modal" id="modalSettings">
    <div class="box">
      <header>
        <h3>إعدادات النظام</h3>
      </header>
      <div style="margin-bottom: 16px;">
        <label>رابط Web App</label>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbxXEwdY-yP3T4O7oFVqvd4T7N1_wkdRVcxps6y7Au7mPNP-ccKQTv6zZ3kIDrK_tiExvw/exec" style="width: 100%; margin-top: 8px;">
        <div class="hint">https://script.google.com/macros/s/AKfycbxXEwdY-yP3T4O7oFVqvd4T7N1_wkdRVcxps6y7Au7mPNP-ccKQTv6zZ3kIDrK_tiExvw/exec</div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label>كود Google Apps Script</label>
        <textarea id="scriptCode" style="width: 100%; height: 200px; margin-top: 8px; padding: 10px; font-family: monospace; border-radius: 8px; border: 1px solid #ddd;" readonly>
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // إنشاء الرؤوس إذا لم تكن موجودة
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(["كود", "الاسم", "الفئة", "الموقع", "المورد", "الحد الأدنى", "الكمية", "السعر", "تاريخ الإضافة", "آخر تحديث"]);
    }
    
    if (action === "add" || action === "update") {
      const item = data.item;
      const rows = sheet.getDataRange().getValues();
      let found = false;
      
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] === item.code) {
          // تحديث العنصر الموجود
          sheet.getRange(i+1, 2, 1, 8).setValues([[item.name, item.category, item.location, item.supplier, item.min, item.qty, item.price, new Date()]]);
          found = true;
          break;
        }
      }
      
      if (!found && action === "add") {
        // إضافة عنصر جديد
        sheet.appendRow([item.code, item.name, item.category, item.location, item.supplier, item.min, item.qty, item.price, new Date(), new Date()]);
      }
      
      return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "list") {
      const rows = sheet.getDataRange().getValues();
      const items = [];
      const categories = new Set();
      
      // تخطي الصف الأول (العناوين)
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0]) {
          items.push({
            code: rows[i][0],
            name: rows[i][1],
            category: rows[i][2],
            location: rows[i][3],
            supplier: rows[i][4],
            min: rows[i][5],
            qty: rows[i][6],
            price: rows[i][7]
          });
          
          if (rows[i][2]) categories.add(rows[i][2]);
        }
      }
      
      // حساب الإحصائيات
      let totalQty = 0;
      let totalValue = 0;
      let lowCount = 0;
      
      items.forEach(item => {
        totalQty += Number(item.qty) || 0;
        totalValue += (Number(item.qty) || 0) * (Number(item.price) || 0);
        if ((Number(item.qty) || 0) <= (Number(item.min) || 0)) lowCount++;
      });
      
      return ContentService.createTextOutput(JSON.stringify({
        items: items,
        stats: {
          items: items.length,
          totalQty: totalQty,
          totalValue: totalValue,
          lowCount: lowCount
        },
        cats: Array.from(categories)
      })).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "delete") {
      const code = data.code;
      const rows = sheet.getDataRange().getValues();
      
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] === code) {
          sheet.deleteRow(i+1);
          break;
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "move") {
      const code = data.code;
      const qty = data.qty;
      const rows = sheet.getDataRange().getValues();
      
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] === code) {
          const currentQty = Number(rows[i][6]) || 0;
          sheet.getRange(i+1, 7).setValue(Math.max(0, currentQty + qty));
          sheet.getRange(i+1, 10).setValue(new Date()); // تحديث وقت التعديل
          break;
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === "test") {
      return ContentService.createTextOutput(JSON.stringify({success: true, message: "الاتصال ناجح"})).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({error: "Action not found"})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({error: error.message})).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet() {
  return ContentService.createTextOutput(JSON.stringify({error: "Use POST requests only"})).setMimeType(ContentService.MimeType.JSON);
}
        </textarea>
        <div class="hint">انسخ هذا الكود والصقه في نافذة Google Apps Script</div>
      </div>
      
      <footer>
        <button onclick="saveSettings()">💾 حفظ الإعدادات</button>
        <button class="secondary" data-close>إلغاء</button>
      </footer>
    </div>
  </div>

  <script>
    /* ======== إعدادات الربط مع Google Apps Script ======== */
    let SCRIPT_URL = localStorage.getItem('scriptUrl') || "";
    let IS_ONLINE = false;

    /* ======== حالة التطبيق ======== */
    let ITEMS = []; // الأصناف
    let FILTER = { q:"", cat:"", status:"" };
    let categoryChart, statusChart;

    // تهيئة الصفحة
    function init() {
      document.getElementById('scriptUrl').value = SCRIPT_URL;
      
      if (SCRIPT_URL) {
        testConnection();
      } else {
        document.getElementById('connectionStatus').textContent = '🔴 غير متصل - يرجى إعداد الاتصال';
        document.getElementById('connectionStatus').style.color = 'var(--danger)';
        document.getElementById('setupGuide').style.display = 'block';
      }
      
      loadLocalData();
      setupEventListeners();
    }

    // اختبار الاتصال
    async function testConnection() {
      if (!SCRIPT_URL) {
        showNotification('يرجى إدخال رابط Web App أولاً', 'error');
        return;
      }
      
      toggleLoader(true);
      showNotification('جاري اختبار الاتصال...', 'info');
      
      try {
        const res = await fetch(SCRIPT_URL, { 
          method: "POST", 
          body: JSON.stringify({ action: "test" }),
          headers: { "Content-Type": "application/json" }
        });
        
        if (res.ok) {
          const data = await res.json();
          IS_ONLINE = true;
          document.getElementById('connectionStatus').textContent = '🟢 متصل - العمل مع Google Sheets';
          document.getElementById('connectionStatus').style.color = 'var(--primary)';
          document.getElementById('setupGuide').style.display = 'none';
          showNotification('تم الاتصال بنجاح', 'success');
          loadAll();
        } else {
          throw new Error('فشل الاتصال');
        }
      } catch (e) {
        IS_ONLINE = false;
        document.getElementById('connectionStatus').textContent = '🔴 غير متصل - العمل في الوضع المحلي';
        document.getElementById('connectionStatus').style.color = 'var(--danger)';
        document.getElementById('setupGuide').style.display = 'block';
        showNotification('تعذر الاتصال، العمل في الوضع المحلي', 'warning');
        loadLocalData();
      } finally {
        toggleLoader(false);
      }
    }

    // تحميل البيانات المحلية
    function loadLocalData() {
      const localData = localStorage.getItem('inventoryData');
      if (localData) {
        ITEMS = JSON.parse(localData);
        renderRows();
        updateStats();
        updateCharts();
        renderAlerts();
      } else {
        // بيانات افتراضية فارغة
        ITEMS = [];
        renderRows();
        updateStats();
      }
    }

    // حفظ البيانات محلياً
    function saveLocalData() {
      localStorage.setItem('inventoryData', JSON.stringify(ITEMS));
    }

    // مساعد لطلبات الشبكة
    async function api(action, payload={}){
      if (!IS_ONLINE) {
        // العمل في الوضع المحلي
        return simulateApi(action, payload);
      }
      
      toggleLoader(true);
      const body = JSON.stringify({ action, ...payload });
      try {
        const res = await fetch(SCRIPT_URL, { method:"POST", body, headers:{"Content-Type":"application/json"} });
        if(!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch (e) {
        IS_ONLINE = false;
        showNotification('فشل الاتصال، الانتقال للوضع المحلي', 'error');
        return simulateApi(action, payload);
      } finally {
        toggleLoader(false);
      }
    }

    // محاكاة API للعمل بدون اتصال
    function simulateApi(action, payload) {
      return new Promise((resolve) => {
        setTimeout(() => {
          let result = {};
          
          switch(action) {
            case "list":
              result = { 
                items: ITEMS,
                stats: calculateStats(),
                cats: [...new Set(ITEMS.map(item => item.category))].filter(Boolean)
              };
              break;
              
            case "add":
              const newItem = payload.item;
              // تجنب التكرار
              if (!ITEMS.some(item => item.code === newItem.code)) {
                ITEMS.push(newItem);
                saveLocalData();
              }
              result = { success: true };
              break;
              
            case "update":
              const updatedItem = payload.item;
              const index = ITEMS.findIndex(item => item.code === updatedItem.code);
              if (index !== -1) {
                ITEMS[index] = updatedItem;
                saveLocalData();
              }
              result = { success: true };
              break;
              
            case "delete":
              ITEMS = ITEMS.filter(item => item.code !== payload.code);
              saveLocalData();
              result = { success: true };
              break;
              
            case "move":
              const itemCode = payload.code;
              const moveQty = payload.qty;
              const itemIndex = ITEMS.findIndex(item => item.code === itemCode);
              
              if (itemIndex !== -1) {
                ITEMS[itemIndex].qty = Math.max(0, (Number(ITEMS[itemIndex].qty) || 0) + moveQty);
                saveLocalData();
                
                // تسجيل الحركة
                const activities = JSON.parse(localStorage.getItem('recentActivities') || '[]');
                activities.unshift({
                  type: moveQty > 0 ? 'in' : 'out',
                  item: itemCode,
                  qty: Math.abs(moveQty),
                  note: payload.note || '',
                  date: new Date().toLocaleString('ar-DZ')
                });
                localStorage.setItem('recentActivities', JSON.stringify(activities.slice(0, 10)));
              }
              result = { success: true };
              break;
          }
          
          resolve(result);
        }, 500); // محاكاة زمن الانتظار
      });
    }

    // تحميل البيانات والإحصاءات
    async function loadAll(){
      try{
        const { items, stats, cats } = await api("list");
        ITEMS = items || [];
        renderRows();
        renderStats(stats||calculateStats());
        renderCats(cats||[]);
        updateCharts();
        renderAlerts();
        renderRecentActivities();
      }catch(e){ showError("تعذّر تحميل البيانات: " + e.message); }
    }

    // حساب الإحصائيات محلياً
    function calculateStats() {
      const totalQty = ITEMS.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
      const totalValue = ITEMS.reduce((sum, item) => sum + ((Number(item.qty) || 0) * (Number(item.price) || 0)), 0);
      const lowCount = ITEMS.filter(item => (Number(item.qty) || 0) <= (Number(item.min) || 0)).length;
      
      return {
        items: ITEMS.length,
        totalQty,
        totalValue,
        lowCount
      };
    }

    function renderCats(cats){
      const sel = document.getElementById('filterCat');
      sel.innerHTML = '<option value="">كل الفئات</option>' + (cats||[]).map(c=>`<option>${c}</option>`).join("");
    }

    function renderStats(s){
      document.getElementById('m_items').textContent = s.items||0;
      document.getElementById('m_qty').textContent = s.totalQty||0;
      document.getElementById('m_value').textContent = (s.totalValue||0).toLocaleString('ar-DZ')+" دج";
      document.getElementById('m_low').textContent = s.lowCount||0;
    }

    function updateStats() {
      const stats = calculateStats();
      renderStats(stats);
    }

    function matchFilter(it){
      const q = FILTER.q.trim().toLowerCase();
      if(q){
        const blob = [it.code,it.name,it.category,it.location,it.supplier].join(' ').toLowerCase();
        if(!blob.includes(q)) return false;
      }
      if(FILTER.cat && it.category!==FILTER.cat) return false;
      const status = (Number(it.qty) || 0) <= (Number(it.min) || 0) ? 'low' : 'ok';
      if(FILTER.status && FILTER.status!==status) return false;
      return true;
    }

    function renderRows(){
      const tbody = document.getElementById('rows');
      if(!ITEMS.length){ tbody.innerHTML = '<tr><td colspan="12" class="empty">لا توجد بيانات</td></tr>'; return; }
      let i=0; const rows = ITEMS.filter(matchFilter).map(it=>{
        const value = (Number(it.qty||0)*Number(it.price||0));
        const low = Number(it.qty||0) <= Number(it.min||0);
        return `<tr>
          <td>${++i}</td>
          <td><span class="badge">${escapeHtml(it.code||'')}</span></td>
          <td>${escapeHtml(it.name||'')}</td>
          <td>${escapeHtml(it.category||'')}</td>
          <td>${escapeHtml(it.location||'')}</td>
          <td>${escapeHtml(it.supplier||'')}</td>
          <td>${it.min||0}</td>
          <td>${it.qty||0}</td>
          <td>${Number(it.price||0).toLocaleString('ar-DZ')}</td>
          <td>${value.toLocaleString('ar-DZ')}</td>
          <td>${low?'<span class="pill low">منخفض</span>':'<span class="pill ok">جيد</span>'}</td>
          <td>
            <button class="secondary" onclick='openItem(${JSON.stringify(it)})'>تعديل</button>
            <button class="danger" onclick='delItem("${encodeURIComponent(it.code)}")'>حذف</button>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows || '<tr><td colspan="12" class="empty">لا نتائج مطابقة</td></tr>';
    }

    function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    // فتح نافذة الصنف (إضافة/تعديل)
    function openItem(it){
      document.getElementById('formTitle').textContent = it? 'تعديل صنف' : 'إضافة صنف';
      document.getElementById('f_code').value = it?.code||'';
      document.getElementById('f_name').value = it?.name||'';
      document.getElementById('f_cat').value = it?.category||'';
      document.getElementById('f_loc').value = it?.location||'';
      document.getElementById('f_supplier').value = it?.supplier||'';
      document.getElementById('f_min').value = it?.min||0;
      document.getElementById('f_qty').value = it?.qty||0;
      document.getElementById('f_price').value = it?.price||0;
      showModal('modalItem', true);
      // جعل رقم الصنف غير قابل للتعديل أثناء وضع التعديل
      document.getElementById('f_code').disabled = !!it;
    }

    async function saveItem(){
      const payload = {
        code: val('f_code'), name: val('f_name'), category: val('f_cat'), location: val('f_loc'), supplier: val('f_supplier'),
        min: num('f_min'), qty: num('f_qty'), price: num('f_price')
      };
      if(!payload.code || !payload.name) return showError('رقم الصنف واسم القطعة حقول إجبارية');
      try{
        const mode = document.getElementById('f_code').disabled ? 'update' : 'add';
        await api(mode, { item: payload });
        await loadAll();
        showModal('modalItem', false);
        showSuccess('تم حفظ الصنف بنجاح');
      }catch(e){ showError('فشل الحفظ: '+e.message); }
    }

    async function delItem(code){
      if(!confirm('تأكيد حذف الصنف؟')) return;
      try{
        await api('delete', { code: decodeURIComponent(code) });
        await loadAll();
        showSuccess('تم حذف الصنف بنجاح');
      }catch(e){ showError('تعذّر الحذف: '+e.message); }
    }

    // حركة مخزونية
    let MOVE_TYPE = 'in';
    function openMove(type){
      MOVE_TYPE = type; // 'in' or 'out'
      document.getElementById('moveTitle').textContent = type==='in' ? 'إدخال مخزوني' : 'إخراج مخزوني';
      showModal('modalMove', true);
    }

    async function applyMove(){
      const code = val('mv_code');
      const qty  = num('mv_qty');
      const note = val('mv_note');
      if(!code || !qty) return showError('رقم الصنف والكمية مطلوبان');
      try{
        await api('move', { code, qty:(MOVE_TYPE==='out'?-Math.abs(qty):Math.abs(qty)), note });
        await loadAll();
        showModal('modalMove', false);
        showSuccess('تم تنفيذ الحركة بنجاح');
      }catch(e){ showError('تعذّر تنفيذ الحركة: '+e.message); }
    }

    // تصدير إلى Excel
    function exportToExcel(){
      if (!ITEMS.length) return showError('لا توجد بيانات للتصدير');
      
      try {
        // إعداد البيانات للتصدير
        const data = ITEMS.map(item => ({
          'رقم الصنف': item.code,
          'اسم القطعة': item.name,
          'الفئة': item.category,
          'الموقع': item.location,
          'المورد': item.supplier,
          'الحد الأدنى': item.min,
          'الكمية': item.qty,
          'سعر الوحدة': item.price,
          'القيمة': (Number(item.qty) || 0) * (Number(item.price) || 0),
          'الحالة': (Number(item.qty) || 0) <= (Number(item.min) || 0) ? 'منخفض' : 'جيد'
        }));
        
        // إنشاء ورقة عمل
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'المخزون');
        
        // تصدير الملف
        XLSX.writeFile(wb, 'جرد_المخزون.xlsx');
        showSuccess('تم تصدير البيانات إلى Excel بنجاح');
      } catch (e) {
        showError('فشل في تصدير الملف: ' + e.message);
      }
    }

    // إنشاء الرسوم البيانية
    function updateCharts() {
      // رسم توزيع المخزون حسب الفئة
      const categories = {};
      ITEMS.forEach(item => {
        const cat = item.category || 'غير مصنف';
        categories[cat] = (categories[cat] || 0) + (Number(item.qty) || 0);
      });
      
      if (categoryChart) categoryChart.destroy();
      const catCtx = document.getElementById('categoryChart').getContext('2d');
      categoryChart = new Chart(catCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(categories),
          datasets: [{
            data: Object.values(categories),
            backgroundColor: ['#2e7d32', '#1565c0', '#d32f2f', '#ffa000', '#7b1fa2', '#00897b', '#f57c00', '#5d4037']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'left',
              rtl: true
            }
          }
        }
      });
      
      // رسم الحالة المخزنية
      let lowCount = 0, okCount = 0;
      ITEMS.forEach(item => {
        if (Number(item.qty) <= Number(item.min)) lowCount++;
        else okCount++;
      });
      
      if (statusChart) statusChart.destroy();
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['تحت الحد الأدنى', 'ضمن المخزون الآمن'],
          datasets: [{
            data: [lowCount, okCount],
            backgroundColor: ['#ef6c00', '#2e7d32']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'left',
              rtl: true
            }
          }
        }
      });
    }

    // عرض التنبيهات
    function renderAlerts() {
      const container = document.getElementById('alertsContainer');
      const lowItems = ITEMS.filter(item => Number(item.qty) <= Number(item.min));
      
      if (lowItems.length === 0) {
        container.innerHTML = '<div class="alert info"><i class="fas fa-info-circle"></i> <div>جميع الأصناف ضمن المخزون الآمن</div></div>';
        return;
      }
      
      container.innerHTML = `
        <div class="alert warning">
          <i class="fas fa-exclamation-triangle"></i>
          <div>هناك ${lowItems.length} أصناف تحت الحد الأدنى للمخزون تحتاج إلى مراجعة</div>
        </div>
      `;
    }

    // عرض الحركات الحديثة
    function renderRecentActivities() {
      const container = document.getElementById('recentActivities');
      const activities = JSON.parse(localStorage.getItem('recentActivities') || '[]');
      
      if (activities.length === 0) {
        container.innerHTML = '<div class="empty">لا توجد حركات حديثة</div>';
        return;
      }
      
      container.innerHTML = activities.map(act => `
        <div class="activity-item">
          <div class="activity-type">
            <i class="fas ${act.type === 'in' ? 'fa-arrow-down activity-in' : 'fa-arrow-up activity-out'}"></i>
            <span>${act.type === 'in' ? 'إدخال' : 'إخراج'} ${act.qty} وحدة من ${act.item}</span>
          </div>
          <div>
            <span class="activity-note">${act.note}</span>
            <span class="activity-date">${act.date}</span>
          </div>
        </div>
      `).join('');
    }

    // إعدادات النظام
    function saveSettings() {
      const newUrl = document.getElementById('scriptUrl').value;
      if (newUrl) {
        SCRIPT_URL = newUrl;
        localStorage.setItem('scriptUrl', newUrl);
        showNotification('تم حفظ الإعدادات بنجاح', 'success');
        showModal('modalSettings', false);
        testConnection();
      }
    }

    // أدوات عامة
    function val(id){return document.getElementById(id).value.trim();}
    function num(id){return Number(document.getElementById(id).value||0)}
    function showModal(id,show){ 
      document.getElementById(id).classList.toggle('show', !!show); 
      if (show) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = 'auto';
      }
    }
    function toggleLoader(show){ document.getElementById('mainLoader').style.display = show ? 'block' : 'none'; }
    
    function showError(msg){ 
      showNotification(msg, 'error');
    }
    
    function showSuccess(msg){ 
      showNotification(msg, 'success');
    }
    
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      const text = document.getElementById('notificationText');
      
      notification.className = `notification ${type}`;
      text.textContent = message;
      
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // إعداد مستمعي الأحداث
    function setupEventListeners() {
      document.getElementById('btnAdd').onclick = ()=>openItem();
      document.getElementById('btnIn').onclick  = ()=>openMove('in');
      document.getElementById('btnOut').onclick = ()=>openMove('out');
      document.getElementById('btnRefresh').onclick = loadAll;
      document.getElementById('btnExport').onclick = exportToExcel;
      document.getElementById('btnSettings').onclick = ()=>showModal('modalSettings', true);
      
      document.querySelectorAll('[data-close]').forEach(el=>el.onclick=()=>{
        el.closest('.modal').classList.remove('show');
        document.body.style.overflow = 'auto';
      });
      
      document.getElementById('saveItem').onclick = saveItem;
      document.getElementById('applyMove').onclick = applyMove;

      document.getElementById('search').oninput = e=>{ FILTER.q = e.target.value; renderRows(); };
      document.getElementById('filterCat').onchange = e=>{ FILTER.cat = e.target.value; renderRows(); };
      document.getElementById('filterStatus').onchange = e=>{ FILTER.status = e.target.value; renderRows(); };
    }

    // بدء التشغيل
    init();
  </script>
</body>
</html>
